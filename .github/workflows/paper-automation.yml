name: Paper Automation

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "scripts/**"
      - "src/**"
      - "configs/**"
      - "results/**"
      - "paper/**"
      - ".github/workflows/paper-automation.yml"
  schedule:
    - cron: "0 3 * * *"

permissions:
  contents: write

concurrency:
  group: paper-automation-${{ github.ref }}
  cancel-in-progress: true

jobs:
  refresh-paper:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Refresh deterministic baseline
        run: |
          export PYTHONPATH=src
          python3 scripts/report_excess_baseline.py \
            --start 500 \
            --end 20000 \
            --step 100 \
            --fixed-points 500,700,1000 \
            --out-dir results/excess_baseline

      - name: Refresh available reports
        run: |
          export PYTHONPATH=src
          if [ -f results/e_hunt_delete_repair/summary.json ]; then
            python3 scripts/generate_research_report_cycle1.py \
              --baseline-summary results/excess_baseline/excess_summary.json \
              --e-hunt-summary results/e_hunt_delete_repair/summary.json \
              --out results/research_report_cycle1.md
          fi
          if [ -f results/e_hunt_delete_repair/summary.json ]; then
            python3 scripts/generate_research_report_to_date.py \
              --baseline-summary results/excess_baseline/excess_summary.json \
              --cycle1-summary results/e_hunt_delete_repair/summary.json \
              --cycle2-root results/e_hunt_breakthrough_cycle2 \
              --cycle2-config configs/e_hunt_breakthrough_cycle2.json \
              --out results/research_report_to_date.md
          fi
          if [ -f results/e_hunt_delete_repair/summary.json ] && [ -f results/e_hunt_breakthrough_cycle2/summary.json ]; then
            python3 scripts/generate_research_report_cycle2.py \
              --cycle1-summary results/e_hunt_delete_repair/summary.json \
              --cycle2-summary results/e_hunt_breakthrough_cycle2/summary.json \
              --out results/research_report_cycle2.md
          fi

      - name: Build paper artifacts
        run: |
          python3 scripts/build_paper_artifacts.py --repo-root .

      - name: Upload paper artifact bundle
        uses: actions/upload-artifact@v4
        with:
          name: erdos170-paper-bundle
          path: |
            paper/main.tex
            paper/generated/**
          if-no-files-found: warn

      - name: Commit generated updates
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add results/excess_baseline paper results/research_report_*.md || true
          if git diff --cached --quiet; then
            echo "No generated changes to commit."
          else
            git commit -m "chore(paper): refresh generated artifacts [skip ci]"
            BRANCH="${GITHUB_REF_NAME:-main}"
            if ! git push origin "HEAD:${BRANCH}"; then
              echo "::warning::Non-fast-forward push rejected. Trying fetch+rebase once."
              git fetch origin "${BRANCH}"
              if git rebase "origin/${BRANCH}" && git push origin "HEAD:${BRANCH}"; then
                echo "Push succeeded after rebase."
              else
                echo "::warning::Auto-push still failed after rebase. Continuing workflow."
                git rebase --abort || true
              fi
            fi
          fi

      - name: Optional Overleaf sync
        env:
          OVERLEAF_GIT_URL: ${{ secrets.OVERLEAF_GIT_URL }}
          OVERLEAF_GIT_TOKEN: ${{ secrets.OVERLEAF_GIT_TOKEN }}
          OVERLEAF_GIT_BRANCH: ${{ secrets.OVERLEAF_GIT_BRANCH }}
        run: |
          if [ -z "${OVERLEAF_GIT_URL:-}" ] || [ -z "${OVERLEAF_GIT_TOKEN:-}" ]; then
            echo "Skipping Overleaf sync: missing OVERLEAF_GIT_URL or OVERLEAF_GIT_TOKEN."
            exit 0
          fi

          RAW_OVERLEAF_GIT_URL="$OVERLEAF_GIT_URL"
          case "$RAW_OVERLEAF_GIT_URL" in
            https://git@git.overleaf.com/*)
              OVERLEAF_GIT_URL="https://git.overleaf.com/${RAW_OVERLEAF_GIT_URL#https://git@git.overleaf.com/}"
              echo "Normalized OVERLEAF_GIT_URL from https://git@git.overleaf.com/... to https://git.overleaf.com/..."
              ;;
            https://git.overleaf.com/*)
              OVERLEAF_GIT_URL="$RAW_OVERLEAF_GIT_URL"
              ;;
            *)
              echo "::error::OVERLEAF_GIT_URL is invalid. Expected https://git.overleaf.com/<project_id> or https://git@git.overleaf.com/<project_id>"
              exit 1
              ;;
          esac

          BRANCH="${OVERLEAF_GIT_BRANCH:-master}"
          rm -rf /tmp/overleaf-sync
          export GIT_TERMINAL_PROMPT=0
          AUTH_B64="$(printf 'git:%s' "$OVERLEAF_GIT_TOKEN" | base64 | tr -d '\n')"

          if ! git -c "http.extraHeader=Authorization: Basic ${AUTH_B64}" clone "$OVERLEAF_GIT_URL" /tmp/overleaf-sync 2>/tmp/overleaf_clone.err; then
            echo "::error::Failed to clone Overleaf project. Check OVERLEAF_GIT_URL and OVERLEAF_GIT_TOKEN."
            sed -n '1,120p' /tmp/overleaf_clone.err || true
            exit 1
          fi

          cd /tmp/overleaf-sync
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          echo "Preparing sync to branch ${BRANCH}."

          rsync -a --delete "$GITHUB_WORKSPACE/paper/" /tmp/overleaf-sync/
          git add -A
          if git diff --cached --quiet; then
            echo "No paper changes to sync."
            exit 0
          fi

          git commit -m "Auto-sync paper artifacts $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          if ! git -c "http.extraHeader=Authorization: Basic ${AUTH_B64}" push origin HEAD:"$BRANCH" 2>/tmp/overleaf_push.err; then
            echo "::error::Failed to push to Overleaf. Token may be invalid or branch may be protected."
            sed -n '1,120p' /tmp/overleaf_push.err || true
            exit 1
          fi
